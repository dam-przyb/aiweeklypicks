---
interface Props {
  currentPath?: string;
}

const { currentPath = "/" } = Astro.props;

// Determine active state
const isActive = (path: string) => currentPath === path || currentPath.startsWith(path + "/");

// Get user and session from locals (set by middleware)
const user = Astro.locals.user;
const session = Astro.locals.session;
const supabase = Astro.locals.supabase;

let isAuthenticated = !!user;
let isAdmin = false;
let userEmail = user?.email || "";

// Extract username (part before @) and truncate to max 20 characters
let displayName = "";
if (userEmail) {
  const username = userEmail.split("@")[0];
  if (username.length > 20) {
    displayName = `${username.substring(0, 20)}...`;
  } else {
    displayName = username;
  }
}

try {
  if (user) {
    // Check admin status
    const { data: profile, error: profileError } = await supabase
      .from("profiles")
      .select("is_admin")
      .eq("user_id", user.id)
      .single();

    // Debug logging (you can remove this later)
    console.log("[Header] Admin check:", {
      userId: user.id,
      userEmail: user.email,
      profileData: profile,
      profileError: profileError?.message,
      isAdminValue: profile?.is_admin,
    });

    if (!profileError && profile?.is_admin) {
      isAdmin = true;
    }
  }
} catch (error) {
  // Silently fail - user will see default state
  console.error("Error checking auth state in header:", error);
}
---

<header class="bg-gray-900 text-white shadow-lg">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex items-center justify-between h-16">
      <!-- Logo and Brand -->
      <div class="flex items-center">
        <a href="/" class="flex items-center gap-3 hover:opacity-90 transition-opacity">
          <div
            class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded flex items-center justify-center font-bold text-xl"
          >
            AI
          </div>
          <div>
            <h1 class="text-xl font-bold leading-tight">AI Weekly Picks</h1>
            <p class="text-xs text-gray-400">AI-Powered Stock Analysis</p>
          </div>
        </a>
      </div>

      <!-- Navigation -->
      <nav class="hidden md:flex items-center gap-6">
        <a
          href="/"
          class={`px-3 py-2 rounded-md text-sm font-medium transition-colors ${
            isActive("/") && !isActive("/picks") && !isActive("/admin")
              ? "bg-gray-800 text-white"
              : "text-gray-300 hover:bg-gray-800 hover:text-white"
          }`}
        >
          Reports
        </a>
        <a
          href="/picks"
          class={`px-3 py-2 rounded-md text-sm font-medium transition-colors ${
            isActive("/picks") ? "bg-gray-800 text-white" : "text-gray-300 hover:bg-gray-800 hover:text-white"
          }`}
        >
          Historical Picks
        </a>

        {
          isAdmin && (
            <a
              href="/admin/imports"
              class={`px-3 py-2 rounded-md text-sm font-medium transition-colors flex items-center gap-1 ${
                isActive("/admin") ? "bg-gray-800 text-white" : "text-gray-300 hover:bg-gray-800 hover:text-white"
              }`}
            >
              <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"
                />
              </svg>
              Import Reports
            </a>
          )
        }

        <!-- Legal Dropdown (simplified for now) -->
        <div class="relative group">
          <button
            class="px-3 py-2 rounded-md text-sm font-medium text-gray-300 hover:bg-gray-800 hover:text-white transition-colors flex items-center gap-1"
          >
            Legal
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
          </button>
          <div
            class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50"
          >
            <a href="/legal/tos-en" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
              Terms of Service (EN)
            </a>
            <a href="/legal/tos-pl" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"> Regulamin (PL) </a>
            <div class="border-t border-gray-200"></div>
            <a href="/legal/privacy-en" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
              Privacy Policy (EN)
            </a>
            <a href="/legal/privacy-pl" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
              Polityka Prywatno≈õci (PL)
            </a>
          </div>
        </div>
      </nav>

      <!-- Auth Actions -->
      <div class="hidden md:flex items-center gap-3">
        {
          !isAuthenticated ? (
            <>
              <a
                href="/auth/login"
                class="px-4 py-2 text-sm font-medium text-gray-300 hover:text-white transition-colors"
              >
                Login
              </a>
              <a
                href="/auth/register"
                class="px-4 py-2 text-sm font-medium bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors"
              >
                Register
              </a>
            </>
          ) : (
            <div class="flex items-center gap-3">
              <span class="text-sm text-gray-300" title={userEmail}>
                Hi, {displayName}
              </span>
              <form action="/api/auth/logout" method="POST" class="inline">
                <button
                  type="submit"
                  class="px-4 py-2 text-sm font-medium text-gray-300 hover:text-white transition-colors"
                >
                  Logout
                </button>
              </form>
            </div>
          )
        }
      </div>

      <!-- Mobile menu button -->
      <div class="md:hidden">
        <button
          type="button"
          class="inline-flex items-center justify-center p-2 rounded-md text-gray-400 hover:text-white hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-white"
          aria-expanded="false"
        >
          <span class="sr-only">Open main menu</span>
          <svg class="block h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
          </svg>
        </button>
      </div>
    </div>
  </div>

  <!-- Mobile menu (hidden by default, would need JS to toggle) -->
  <div class="md:hidden hidden" id="mobile-menu">
    <div class="px-2 pt-2 pb-3 space-y-1">
      <a
        href="/"
        class={`block px-3 py-2 rounded-md text-base font-medium ${
          isActive("/") && !isActive("/picks") && !isActive("/admin")
            ? "bg-gray-800 text-white"
            : "text-gray-300 hover:bg-gray-800 hover:text-white"
        }`}
      >
        Reports
      </a>
      <a
        href="/picks"
        class={`block px-3 py-2 rounded-md text-base font-medium ${
          isActive("/picks") ? "bg-gray-800 text-white" : "text-gray-300 hover:bg-gray-800 hover:text-white"
        }`}
      >
        Historical Picks
      </a>
      {
        isAdmin && (
          <a
            href="/admin/imports"
            class={`block px-3 py-2 rounded-md text-base font-medium flex items-center gap-2 ${
              isActive("/admin") ? "bg-gray-800 text-white" : "text-gray-300 hover:bg-gray-800 hover:text-white"
            }`}
          >
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"
              />
            </svg>
            Import Reports
          </a>
        )
      }
      {
        !isAuthenticated ? (
          <>
            <a
              href="/auth/login"
              class="block px-3 py-2 rounded-md text-base font-medium text-gray-300 hover:bg-gray-800 hover:text-white"
            >
              Login
            </a>
            <a
              href="/auth/register"
              class="block px-3 py-2 rounded-md text-base font-medium text-gray-300 hover:bg-gray-800 hover:text-white"
            >
              Register
            </a>
          </>
        ) : (
          <>
            <div class="px-3 py-2 text-sm text-gray-400" title={userEmail}>
              Hi, {displayName}
            </div>
            <form action="/api/auth/logout" method="POST" class="block">
              <button
                type="submit"
                class="w-full text-left px-3 py-2 rounded-md text-base font-medium text-gray-300 hover:bg-gray-800 hover:text-white"
              >
                Logout
              </button>
            </form>
          </>
        )
      }
    </div>
  </div>
</header>
